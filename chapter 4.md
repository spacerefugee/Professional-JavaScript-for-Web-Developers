### 第4章 变量、作用域和内存问题

#### 4.1 基本类型和引用类型的值
- 基本类型值指的是简单的数据段，引用类型值指那些可能由多个值构成的对象。

##### 4.1.1 动态的属性

- 定义基本类型和引用类型值的方式是类似的：创建一个变量并为该变量赋值。但是，当这个值保存到变量中以后，对不同类型值可以执行的操作则大相径庭。对于引用类型的值，我们可以为其添加属性和发放，也可以改变和删除其属性和发放。

##### 4.1.2 复制变量值
- 如果从一个变量向另一个变量复制基本类型的值，会在变量对象上创建一个新值，然后把该值赋值到新变量分配的位置上。因此改变其中一个变量不会影响另一个变量。
- 如果从一个变量向另一个变量赋值引用类型的值时，同样也会将存储在变量对象中的值赋值一份放到为新变量分配的空间中，不同的是，这个值的副本实际上是一个指针，而这个指针指向存储在堆中的一个对象。因此改变其中一个变量就会影响另一个变量。

##### 4.1.3 传递参数
- 基本类型值的传递如同基本类型变量的复制一样，而引用类型值的传递，则如同引用类型变量的复制一样。

##### 4.1.4 检测类型
- typeof操作符是检测类型的最佳工具。但是在检测引用类型的值时，这个操作符用处不大。通常，我们并不是想知道某个值是对象，而是想知道它是什么类型的对象。为此，ECMAScript提供了instanceof操作符，其用法如下：

```
result = variable instanceof constructor
```
- 如果变量是给定引用类型的实例，那么instanceof操作符就会返回true。

#### 4.2 执行环境及作用域
- 执行环境(execution context)定义了变量或函数有权访问的其他数据，决定了它们各自的行为。
- 每个执行环境都有一个与之关联的变量对象(variable object)，环境中定义的所有变量和函数都保存在这个对象中。
- 在Web浏览器中，全集执行环境被认为是window对象，因此所有全局变量和函数都是作为window对象的属性和方法创建的。
- 执行环境中的所有代码执行完毕后，该环境就会被销毁，保存在其中的所有变量和函数定义也随之被销毁。
- 当代码在一个环境中执行时，会创建变量对象的一个作用域链(scope chain)。作用域的用途是保证对执行环境有权访问的所有变量和函数的有序访问。

##### 4.2.1 延长作用域链
- 当执行流进入下列语句时，作用域链就会得到加长：
  - try-catch语句的catch块；
  - with语句。
- 对with语句来说，会将制定的对象添加到作用域链中。对catch语句来说，会创建一个新的变量对象，其中包含的是被抛出的错误对象的声明。

##### 4.2.2 没有块级作用域
- JavaScript没有块级作用域经常会导致理解上的困惑。在其他类C的语言中，由花括号封闭的代码块都有自己的作用域，因而支持根据条件来定义变量。

###### 1. 声明变量
- 使用var声明的变量会自动被添加到最接近的环境中。
- 省略var关键字，该变量会自动被添加到全局环境。

###### 2. 查询标识符
- 当在某个环境中为了读取或写入而引用一个标识符时，必须通过搜索来确定该标识符实际代表什么，在搜索过程中，如果存在一个局部的变量的定义，则搜索会自动停止，不再进入另一个变量对象。

#### 4.3 垃圾收集
- JavaScript具有自动垃圾收集机制。

##### 4.3.1 标记清除(mark-and-sweep)
- 当变量进入环境（例如在函数中声明一个变量）时，就将这个变量标记为“进入环境”。从逻辑上讲，永远不能释放进入环境的变量所占用的内存，因为只要执行流进入相应的环境，就可能会用到它们。而当变量离开环境时，则将其标记为“离开环境”。

##### 4.3.2 引用计数(reference counting)
- 引用计数的含义是跟踪记录每个值被引用的次数。当声明了一个变量并将一个引用类型值赋给该变量时，则这个值的引用次数就是1,。如果同一个值又被赋给另一个变量，则该值的引用次数加1。相反，如果包含对这个值引用的变量又取得了另外一个值，则这个值的引用次数减1。当这个值的引用次数变成0时，则说明没有办法再访问这个值了，因而就可以将其占用的内存空间回收回来。这样，当垃圾收集器下次再运行时，它就会释放那
些引用次数为零的值所占用的内存。

##### 4.3.3 性能问题

##### 4.3.4 管理内存
- 优化内存占用的最佳方式，就是为执行中的代码只保存必要的数据。一旦数据不再有用，最好通过将其值设置为null来释放其引用——这个做法叫做解除引用(dereferencing)。这一做法适用于大多数全局变量和全局对象的属性。局部变量会在它们离开执行环境时自动被解除引用。
